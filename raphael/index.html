<!DOCTYPE html>

<html>

<head>
    <!-- Encoding -->
    <meta charset="UTF-8">
    <!-- Title -->
    <title>CO2</title>
    <!-- Style -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />

</head>

<div id="mapid" style="width: 99%; position:absolute; top:0;bottom:0;"></div>
<button style="position:absolute; z-Index:99999;bottom:50px;left:55%;width:200px;height:100px" id="calc" onclick="getData()">Calculate route!
</button>
<button id="reset" style="position:absolute; z-Index:999;bottom:50px;left:35%;width:200px;height:100px" onclick="resetMarker()">Reset start position
</button>

<!-- JavaScript -->
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<script>
    var map = L.map('mapid').setView([49.41461, 8.681495], 13);

    var marker = L.marker([49.41, 8.675724]).addTo(map);

    var new_event_marker;
    var calculated_route;
    var route_layer;
    var re = false;

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(map);

    function getData() {
        if (typeof(new_event_marker) === 'undefined') {
            alert("Please select a destination.");
            return;
        }

        if (typeof(route_layer) !== 'undefined') {
            map.removeLayer(route_layer);
        }

        var lat = new_event_marker._latlng.lat;
        var lng = new_event_marker._latlng.lng;

        var url = "https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf624866cc48fc26c14cf48ecb30e7c1c5ebf5&start=" + marker._latlng.lng + "," + marker._latlng.lat + "&end=" + lng + "," + lat;
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open("GET", url, false);
        xmlHttp.send(null);

        var geoObject = JSON.parse(xmlHttp.responseText)
        var route_length = geoObject.features[0].properties.summary.distance;
        var co2_car = route_length * 0.143 / 1000; // source: https://www.delijn.be/de/overdelijn/organisatie/zorgzaam-ondernemen/milieu/co2-uitstoot-voertuigen.html
        var co2_bus = route_length * 0.063 / 1000; // source: https://www.delijn.be/de/overdelijn/organisatie/zorgzaam-ondernemen/milieu/co2-uitstoot-voertuigen.html
        var amount = (co2_car - co2_bus).toFixed(3);;
        var statement = route_length < 3000 ? "a little" : "a lot";
        var statement2 = statement == "a little" ? "What about using your bike? CO2 Emission free!" : "Going by Bus could save " + amount + "kg CO2 emissions!";
        calculated_route = geoObject.features[0];
        route_layer = L.geoJSON().addTo(map);
        route_layer.addData(calculated_route);
        new_event_marker.bindPopup("This ride would be contributing " + statement + " to climate change!<br>" + statement2).openPopup();
    }

    map.on('click', function(e) {
        if (re) {
            marker.setLatLng(e.latlng);
            re = false;
            if (typeof(route_layer) !== 'undefined') {
                map.removeLayer(route_layer);
            }
        } else {
            if (typeof(new_event_marker) === 'undefined') {
                new_event_marker = new L.marker(e.latlng, {
                    draggable: true
                });
                new_event_marker.addTo(map);
                if (typeof(route_layer) !== 'undefined') {
                    map.removeLayer(route_layer);
                }
            } else {
                new_event_marker.setLatLng(e.latlng);
                if (typeof(route_layer) !== 'undefined') {
                    map.removeLayer(route_layer);
                }
            }
        }
    });

    function resetMarker() {
        re = true;
    }
</script>

</body>

</html>
