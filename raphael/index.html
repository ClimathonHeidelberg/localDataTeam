<!DOCTYPE html>

<html>

<head>
    <!-- Encoding -->
    <meta charset="UTF-8">
    <!-- Title -->
    <title>CO2</title>
    <!-- Style -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Future work:
        - Add public transportation data, so a user can actually get an alternative
        - Format marker and line color according to CO2 emission (green: ok, yellow: not so good, red: bad)
        - Provide a form so people can actually select with what they are traveling (at the moment, it is a car)
        - Add different vehicles
    -->
</head>

<div>
    <div id="mapid" style="width: 100%; position:absolute; top:0;bottom:0;"></div>

    <div class="container-fluid" style="margin: 0 auto; text-align: center;position:absolute;z-Index:999; top:20px;">
        <h2 style="background-color:gray;border-radius: 7px;"><font color="white">Berechnen Sie die CO2 Emissionen Ihrer Autofahrt</font></h2>
    </div>

    <div class="container-fluid" style="margin: 0 auto; text-align: center;position:absolute;z-Index:999;bottom:50px">
        <button id="reset" class="btn btn-secondary btn-lg" style="background-color:gray;width:200px;height:100px" onclick="resetMarker()">Startposition ändern
        </button>
        <button style="width:200px;height:100px;background-color:gray"  class="btn btn-secondary btn-lg" id="calc" onclick="getData()">Route berechnen!
        </button>
    </div>
</div>
<!-- JavaScript -->
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<script>
    var map = L.map('mapid', {zoomControl: false}).setView([49.41, 8.681495], 13)
    var api_key = ""; // get an API-key at https://openrouteservice.org and put it here :)
    map.setMaxBounds([
		[49.3, 8.3],
		[49.6, 8.9]
	]);
	L.control.zoom({
     position:'bottomleft'
        }).addTo(map);

    var marker = L.marker([49.419296, 8.675724]).addTo(map);

    var new_event_marker;
    var calculated_route;
    var route_layer;
    var re = false;

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(map);

    function getData() {
        if (typeof(new_event_marker) === 'undefined') {
            alert("Please select a destination.");
            return;
        }

        if (typeof(route_layer) !== 'undefined') {
            map.removeLayer(route_layer);
        }

        var lat = new_event_marker._latlng.lat;
        var lng = new_event_marker._latlng.lng;

        var url = "https://api.openrouteservice.org/v2/directions/driving-car?api_key=" + api_key + "&start=" + marker._latlng.lng + "," + marker._latlng.lat + "&end=" + lng + "," + lat;
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open("GET", url, false);
        xmlHttp.send(null);

        var geoObject = JSON.parse(xmlHttp.responseText)
        var route_length = geoObject.features[0].properties.summary.distance;
        var co2_car = route_length * 0.143; // source: https://www.delijn.be/de/overdelijn/organisatie/zorgzaam-ondernemen/milieu/co2-uitstoot-voertuigen.html
        var co2_bus = route_length * 0.063; // source: https://www.delijn.be/de/overdelijn/organisatie/zorgzaam-ondernemen/milieu/co2-uitstoot-voertuigen.html
        var amount = (co2_car - co2_bus).toFixed(0);;
        var statement = route_length < 3000 ? "ein bisschen" : "mehr";
        var statement2 = statement == "ein bisschen" ? "Fahre das doch mit dem Rad. <br> <font color='green'>CO2 emissionsfrei!</font>" : "Mit dem Bus könnten <font color='red'>" + amount + " Gramm </font> CO2 Emissionen eingespart werden!";
        calculated_route = geoObject.features[0];
        route_layer = L.geoJSON().addTo(map);
        route_layer.addData(calculated_route);
        new_event_marker.bindPopup("<center><font size=4>Diese Fahrt würde  " + statement + " zum Klimawandel beitragen.<br>" + statement2 + "</font></center>").openPopup();
    }

    map.on('click', function(e) {
        if (re) {
            marker.setLatLng(e.latlng);
            re = false;
            if (typeof(route_layer) !== 'undefined') {
                map.removeLayer(route_layer);
            }
        } else {
            if (typeof(new_event_marker) === 'undefined') {
                new_event_marker = new L.marker(e.latlng, {
                    draggable: true
                });
                new_event_marker.addTo(map);
                if (typeof(route_layer) !== 'undefined') {
                    map.removeLayer(route_layer);
                }
            } else {
                new_event_marker.setLatLng(e.latlng);
                if (typeof(route_layer) !== 'undefined') {
                    map.removeLayer(route_layer);
                }
            }
        }
    });

    function resetMarker() {
        re = true;
    }
</script>

</body>

</html>
